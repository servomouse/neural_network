#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <math.h>
#include "network.h"
#include "utils.h"

// Micronet config:
// #include "dataset_large_1000.h"
#include "micro_maps/config_feedback_micronet.h"
#include "micro_maps/config_poly_micronet.h"

#define sizeof_arr(_x) sizeof(_x)/sizeof(_x[0])

typedef struct {
    double inputs[8];
    double output[8];
} dataset_item_t;

dataset_item_t train_dataset[] = {
    {{0, 0, 0, 0, 0, 0, 0, 0}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 0, 0, 0, 0}, {1, 0, 0, 0, 0, 0, 0, 0}},
    {{0, 1, 0, 0, 0, 0, 0, 0}, {0, 0, 1, 0, 0, 0, 0, 0}},
    {{1, 1, 0, 0, 0, 0, 0, 0}, {1, 0, 0, 1, 0, 0, 0, 0}},
    {{0, 0, 1, 0, 0, 0, 0, 0}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 0, 0, 0, 0, 0}, {1, 0, 0, 1, 1, 0, 0, 0}},
    {{0, 1, 1, 0, 0, 0, 0, 0}, {0, 0, 1, 0, 0, 1, 0, 0}},
    {{1, 1, 1, 0, 0, 0, 0, 0}, {1, 0, 0, 0, 1, 1, 0, 0}},
    {{0, 0, 0, 1, 0, 0, 0, 0}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 0, 0, 0, 0}, {1, 0, 0, 0, 1, 0, 1, 0}},
    {{0, 1, 0, 1, 0, 0, 0, 0}, {0, 0, 1, 0, 0, 1, 1, 0}},
    {{1, 1, 0, 1, 0, 0, 0, 0}, {1, 0, 0, 1, 1, 1, 1, 0}},
    {{0, 0, 1, 1, 0, 0, 0, 0}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 1, 0, 0, 0, 0}, {1, 0, 0, 1, 0, 1, 0, 1}},
    {{0, 1, 1, 1, 0, 0, 0, 0}, {0, 0, 1, 0, 0, 0, 1, 1}},
    {{1, 1, 1, 1, 0, 0, 0, 0}, {1, 0, 0, 0, 0, 1, 1, 1}},
    {{0, 0, 0, 0, 1, 0, 0, 0}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 1, 0, 0, 0}, {1, 0, 0, 0, 0, 1, 0, 0}},
    {{0, 1, 0, 0, 1, 0, 0, 0}, {0, 0, 1, 0, 0, 0, 1, 0}},
    {{1, 1, 0, 0, 1, 0, 0, 0}, {1, 0, 0, 1, 0, 1, 1, 0}},
    {{0, 0, 1, 0, 1, 0, 0, 0}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 0, 1, 0, 0, 0}, {1, 0, 0, 1, 1, 1, 0, 1}},
    {{0, 1, 1, 0, 1, 0, 0, 0}, {0, 0, 1, 0, 0, 1, 1, 1}},
    {{1, 1, 1, 0, 1, 0, 0, 0}, {1, 0, 0, 0, 1, 0, 0, 0}},
    {{0, 0, 0, 1, 1, 0, 0, 0}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 1, 0, 0, 0}, {1, 0, 0, 0, 1, 1, 1, 0}},
    {{0, 1, 0, 1, 1, 0, 0, 0}, {0, 0, 1, 0, 0, 1, 0, 1}},
    {{1, 1, 0, 1, 1, 0, 0, 0}, {1, 0, 0, 1, 1, 0, 1, 1}},
    {{0, 0, 1, 1, 1, 0, 0, 0}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 1, 1, 0, 0, 0}, {1, 0, 0, 1, 0, 0, 1, 0}},
    {{0, 1, 1, 1, 1, 0, 0, 0}, {0, 0, 1, 0, 0, 0, 0, 1}},
    {{1, 1, 1, 1, 1, 0, 0, 0}, {1, 0, 0, 0, 0, 0, 1, 1}},
    {{0, 0, 0, 0, 0, 1, 0, 0}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 0, 1, 0, 0}, {1, 0, 0, 0, 0, 0, 1, 0}},
    {{0, 1, 0, 0, 0, 1, 0, 0}, {0, 0, 1, 0, 0, 0, 0, 1}},
    {{1, 1, 0, 0, 0, 1, 0, 0}, {1, 0, 0, 1, 0, 0, 1, 1}},
    {{0, 0, 1, 0, 0, 1, 0, 0}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 0, 0, 1, 0, 0}, {1, 0, 0, 1, 1, 0, 1, 0}},
    {{0, 1, 1, 0, 0, 1, 0, 0}, {0, 0, 1, 0, 0, 1, 0, 1}},
    {{1, 1, 1, 0, 0, 1, 0, 0}, {1, 0, 0, 0, 1, 1, 1, 1}},
    {{0, 0, 0, 1, 0, 1, 0, 0}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 0, 1, 0, 0}, {1, 0, 0, 0, 1, 0, 0, 1}},
    {{0, 1, 0, 1, 0, 1, 0, 0}, {0, 0, 1, 0, 0, 1, 1, 1}},
    {{1, 1, 0, 1, 0, 1, 0, 0}, {1, 0, 0, 1, 1, 1, 0, 0}},
    {{0, 0, 1, 1, 0, 1, 0, 0}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 1, 0, 1, 0, 0}, {1, 0, 0, 1, 0, 1, 1, 1}},
    {{0, 1, 1, 1, 0, 1, 0, 0}, {0, 0, 1, 0, 0, 0, 1, 0}},
    {{1, 1, 1, 1, 0, 1, 0, 0}, {1, 0, 0, 0, 0, 1, 0, 1}},
    {{0, 0, 0, 0, 1, 1, 0, 0}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 1, 1, 0, 0}, {1, 0, 0, 0, 0, 1, 1, 0}},
    {{0, 1, 0, 0, 1, 1, 0, 0}, {0, 0, 1, 0, 0, 0, 1, 1}},
    {{1, 1, 0, 0, 1, 1, 0, 0}, {1, 0, 0, 1, 0, 1, 0, 0}},
    {{0, 0, 1, 0, 1, 1, 0, 0}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 0, 1, 1, 0, 0}, {1, 0, 0, 1, 1, 1, 1, 1}},
    {{0, 1, 1, 0, 1, 1, 0, 0}, {0, 0, 1, 0, 0, 1, 1, 0}},
    {{1, 1, 1, 0, 1, 1, 0, 0}, {1, 0, 0, 0, 1, 0, 1, 1}},
    {{0, 0, 0, 1, 1, 1, 0, 0}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 1, 1, 0, 0}, {1, 0, 0, 0, 1, 1, 0, 1}},
    {{0, 1, 0, 1, 1, 1, 0, 0}, {0, 0, 1, 0, 0, 1, 0, 0}},
    {{1, 1, 0, 1, 1, 1, 0, 0}, {1, 0, 0, 1, 1, 0, 0, 1}},
    {{0, 0, 1, 1, 1, 1, 0, 0}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 1, 1, 1, 0, 0}, {1, 0, 0, 1, 0, 0, 0, 1}},
    {{0, 1, 1, 1, 1, 1, 0, 0}, {0, 0, 1, 0, 0, 0, 0, 0}},
    {{1, 1, 1, 1, 1, 1, 0, 0}, {1, 0, 0, 0, 0, 0, 0, 1}},
    {{0, 0, 0, 0, 0, 0, 1, 0}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 0, 0, 1, 0}, {1, 0, 0, 0, 0, 0, 0, 1}},
    {{0, 1, 0, 0, 0, 0, 1, 0}, {0, 0, 1, 0, 0, 0, 0, 0}},
    {{1, 1, 0, 0, 0, 0, 1, 0}, {1, 0, 0, 1, 0, 0, 0, 1}},
    {{0, 0, 1, 0, 0, 0, 1, 0}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 0, 0, 0, 1, 0}, {1, 0, 0, 1, 1, 0, 0, 1}},
    {{0, 1, 1, 0, 0, 0, 1, 0}, {0, 0, 1, 0, 0, 1, 0, 0}},
    {{1, 1, 1, 0, 0, 0, 1, 0}, {1, 0, 0, 0, 1, 1, 0, 1}},
    {{0, 0, 0, 1, 0, 0, 1, 0}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 0, 0, 1, 0}, {1, 0, 0, 0, 1, 0, 1, 1}},
    {{0, 1, 0, 1, 0, 0, 1, 0}, {0, 0, 1, 0, 0, 1, 1, 0}},
    {{1, 1, 0, 1, 0, 0, 1, 0}, {1, 0, 0, 1, 1, 1, 1, 1}},
    {{0, 0, 1, 1, 0, 0, 1, 0}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 1, 0, 0, 1, 0}, {1, 0, 0, 1, 0, 1, 0, 0}},
    {{0, 1, 1, 1, 0, 0, 1, 0}, {0, 0, 1, 0, 0, 0, 1, 1}},
    {{1, 1, 1, 1, 0, 0, 1, 0}, {1, 0, 0, 0, 0, 1, 1, 0}},
    {{0, 0, 0, 0, 1, 0, 1, 0}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 1, 0, 1, 0}, {1, 0, 0, 0, 0, 1, 0, 1}},
    {{0, 1, 0, 0, 1, 0, 1, 0}, {0, 0, 1, 0, 0, 0, 1, 0}},
    {{1, 1, 0, 0, 1, 0, 1, 0}, {1, 0, 0, 1, 0, 1, 1, 1}},
    {{0, 0, 1, 0, 1, 0, 1, 0}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 0, 1, 0, 1, 0}, {1, 0, 0, 1, 1, 1, 0, 0}},
    {{0, 1, 1, 0, 1, 0, 1, 0}, {0, 0, 1, 0, 0, 1, 1, 1}},
    {{1, 1, 1, 0, 1, 0, 1, 0}, {1, 0, 0, 0, 1, 0, 0, 1}},
    {{0, 0, 0, 1, 1, 0, 1, 0}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 1, 0, 1, 0}, {1, 0, 0, 0, 1, 1, 1, 1}},
    {{0, 1, 0, 1, 1, 0, 1, 0}, {0, 0, 1, 0, 0, 1, 0, 1}},
    {{1, 1, 0, 1, 1, 0, 1, 0}, {1, 0, 0, 1, 1, 0, 1, 0}},
    {{0, 0, 1, 1, 1, 0, 1, 0}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 1, 1, 0, 1, 0}, {1, 0, 0, 1, 0, 0, 1, 1}},
    {{0, 1, 1, 1, 1, 0, 1, 0}, {0, 0, 1, 0, 0, 0, 0, 1}},
    {{1, 1, 1, 1, 1, 0, 1, 0}, {1, 0, 0, 0, 0, 0, 1, 0}},
    {{0, 0, 0, 0, 0, 1, 1, 0}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 0, 1, 1, 0}, {1, 0, 0, 0, 0, 0, 1, 1}},
    {{0, 1, 0, 0, 0, 1, 1, 0}, {0, 0, 1, 0, 0, 0, 0, 1}},
    {{1, 1, 0, 0, 0, 1, 1, 0}, {1, 0, 0, 1, 0, 0, 1, 0}},
    {{0, 0, 1, 0, 0, 1, 1, 0}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 0, 0, 1, 1, 0}, {1, 0, 0, 1, 1, 0, 1, 1}},
    {{0, 1, 1, 0, 0, 1, 1, 0}, {0, 0, 1, 0, 0, 1, 0, 1}},
    {{1, 1, 1, 0, 0, 1, 1, 0}, {1, 0, 0, 0, 1, 1, 1, 0}},
    {{0, 0, 0, 1, 0, 1, 1, 0}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 0, 1, 1, 0}, {1, 0, 0, 0, 1, 0, 0, 0}},
    {{0, 1, 0, 1, 0, 1, 1, 0}, {0, 0, 1, 0, 0, 1, 1, 1}},
    {{1, 1, 0, 1, 0, 1, 1, 0}, {1, 0, 0, 1, 1, 1, 0, 1}},
    {{0, 0, 1, 1, 0, 1, 1, 0}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 1, 0, 1, 1, 0}, {1, 0, 0, 1, 0, 1, 1, 0}},
    {{0, 1, 1, 1, 0, 1, 1, 0}, {0, 0, 1, 0, 0, 0, 1, 0}},
    {{1, 1, 1, 1, 0, 1, 1, 0}, {1, 0, 0, 0, 0, 1, 0, 0}},
    {{0, 0, 0, 0, 1, 1, 1, 0}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 1, 1, 1, 0}, {1, 0, 0, 0, 0, 1, 1, 1}},
    {{0, 1, 0, 0, 1, 1, 1, 0}, {0, 0, 1, 0, 0, 0, 1, 1}},
    {{1, 1, 0, 0, 1, 1, 1, 0}, {1, 0, 0, 1, 0, 1, 0, 1}},
    {{0, 0, 1, 0, 1, 1, 1, 0}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 0, 1, 1, 1, 0}, {1, 0, 0, 1, 1, 1, 1, 0}},
    {{0, 1, 1, 0, 1, 1, 1, 0}, {0, 0, 1, 0, 0, 1, 1, 0}},
    {{1, 1, 1, 0, 1, 1, 1, 0}, {1, 0, 0, 0, 1, 0, 1, 0}},
    {{0, 0, 0, 1, 1, 1, 1, 0}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 1, 1, 1, 0}, {1, 0, 0, 0, 1, 1, 0, 0}},
    {{0, 1, 0, 1, 1, 1, 1, 0}, {0, 0, 1, 0, 0, 1, 0, 0}},
    {{1, 1, 0, 1, 1, 1, 1, 0}, {1, 0, 0, 1, 1, 0, 0, 0}},
    {{0, 0, 1, 1, 1, 1, 1, 0}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 1, 1, 1, 1, 0}, {1, 0, 0, 1, 0, 0, 0, 0}},
    {{0, 1, 1, 1, 1, 1, 1, 0}, {0, 0, 1, 0, 0, 0, 0, 0}},
    {{1, 1, 1, 1, 1, 1, 1, 0}, {1, 0, 0, 0, 0, 0, 0, 0}},
    {{0, 0, 0, 0, 0, 0, 0, 1}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 0, 0, 0, 1}, {1, 0, 0, 0, 0, 0, 0, 0}},
    {{0, 1, 0, 0, 0, 0, 0, 1}, {0, 0, 1, 0, 0, 0, 0, 0}},
    {{1, 1, 0, 0, 0, 0, 0, 1}, {1, 0, 0, 1, 0, 0, 0, 0}},
    {{0, 0, 1, 0, 0, 0, 0, 1}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 0, 0, 0, 0, 1}, {1, 0, 0, 1, 1, 0, 0, 0}},
    {{0, 1, 1, 0, 0, 0, 0, 1}, {0, 0, 1, 0, 0, 1, 0, 0}},
    {{1, 1, 1, 0, 0, 0, 0, 1}, {1, 0, 0, 0, 1, 1, 0, 0}},
    {{0, 0, 0, 1, 0, 0, 0, 1}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 0, 0, 0, 1}, {1, 0, 0, 0, 1, 0, 1, 0}},
    {{0, 1, 0, 1, 0, 0, 0, 1}, {0, 0, 1, 0, 0, 1, 1, 0}},
    {{1, 1, 0, 1, 0, 0, 0, 1}, {1, 0, 0, 1, 1, 1, 1, 0}},
    {{0, 0, 1, 1, 0, 0, 0, 1}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 1, 0, 0, 0, 1}, {1, 0, 0, 1, 0, 1, 0, 1}},
    {{0, 1, 1, 1, 0, 0, 0, 1}, {0, 0, 1, 0, 0, 0, 1, 1}},
    {{1, 1, 1, 1, 0, 0, 0, 1}, {1, 0, 0, 0, 0, 1, 1, 1}},
    {{0, 0, 0, 0, 1, 0, 0, 1}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 1, 0, 0, 1}, {1, 0, 0, 0, 0, 1, 0, 0}},
    {{0, 1, 0, 0, 1, 0, 0, 1}, {0, 0, 1, 0, 0, 0, 1, 0}},
    {{1, 1, 0, 0, 1, 0, 0, 1}, {1, 0, 0, 1, 0, 1, 1, 0}},
    {{0, 0, 1, 0, 1, 0, 0, 1}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 0, 1, 0, 0, 1}, {1, 0, 0, 1, 1, 1, 0, 1}},
    {{0, 1, 1, 0, 1, 0, 0, 1}, {0, 0, 1, 0, 0, 1, 1, 1}},
    {{1, 1, 1, 0, 1, 0, 0, 1}, {1, 0, 0, 0, 1, 0, 0, 0}},
    {{0, 0, 0, 1, 1, 0, 0, 1}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 1, 0, 0, 1}, {1, 0, 0, 0, 1, 1, 1, 0}},
    {{0, 1, 0, 1, 1, 0, 0, 1}, {0, 0, 1, 0, 0, 1, 0, 1}},
    {{1, 1, 0, 1, 1, 0, 0, 1}, {1, 0, 0, 1, 1, 0, 1, 1}},
    {{0, 0, 1, 1, 1, 0, 0, 1}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 1, 1, 0, 0, 1}, {1, 0, 0, 1, 0, 0, 1, 0}},
    {{0, 1, 1, 1, 1, 0, 0, 1}, {0, 0, 1, 0, 0, 0, 0, 1}},
    {{1, 1, 1, 1, 1, 0, 0, 1}, {1, 0, 0, 0, 0, 0, 1, 1}},
    {{0, 0, 0, 0, 0, 1, 0, 1}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 0, 1, 0, 1}, {1, 0, 0, 0, 0, 0, 1, 0}},
    {{0, 1, 0, 0, 0, 1, 0, 1}, {0, 0, 1, 0, 0, 0, 0, 1}},
    {{1, 1, 0, 0, 0, 1, 0, 1}, {1, 0, 0, 1, 0, 0, 1, 1}},
    {{0, 0, 1, 0, 0, 1, 0, 1}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 0, 0, 1, 0, 1}, {1, 0, 0, 1, 1, 0, 1, 0}},
    {{0, 1, 1, 0, 0, 1, 0, 1}, {0, 0, 1, 0, 0, 1, 0, 1}},
    {{1, 1, 1, 0, 0, 1, 0, 1}, {1, 0, 0, 0, 1, 1, 1, 1}},
    {{0, 0, 0, 1, 0, 1, 0, 1}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 0, 1, 0, 1}, {1, 0, 0, 0, 1, 0, 0, 1}},
    {{0, 1, 0, 1, 0, 1, 0, 1}, {0, 0, 1, 0, 0, 1, 1, 1}},
    {{1, 1, 0, 1, 0, 1, 0, 1}, {1, 0, 0, 1, 1, 1, 0, 0}},
    {{0, 0, 1, 1, 0, 1, 0, 1}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 1, 0, 1, 0, 1}, {1, 0, 0, 1, 0, 1, 1, 1}},
    {{0, 1, 1, 1, 0, 1, 0, 1}, {0, 0, 1, 0, 0, 0, 1, 0}},
    {{1, 1, 1, 1, 0, 1, 0, 1}, {1, 0, 0, 0, 0, 1, 0, 1}},
    {{0, 0, 0, 0, 1, 1, 0, 1}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 1, 1, 0, 1}, {1, 0, 0, 0, 0, 1, 1, 0}},
    {{0, 1, 0, 0, 1, 1, 0, 1}, {0, 0, 1, 0, 0, 0, 1, 1}},
    {{1, 1, 0, 0, 1, 1, 0, 1}, {1, 0, 0, 1, 0, 1, 0, 0}},
    {{0, 0, 1, 0, 1, 1, 0, 1}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 0, 1, 1, 0, 1}, {1, 0, 0, 1, 1, 1, 1, 1}},
    {{0, 1, 1, 0, 1, 1, 0, 1}, {0, 0, 1, 0, 0, 1, 1, 0}},
    {{1, 1, 1, 0, 1, 1, 0, 1}, {1, 0, 0, 0, 1, 0, 1, 1}},
    {{0, 0, 0, 1, 1, 1, 0, 1}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 1, 1, 0, 1}, {1, 0, 0, 0, 1, 1, 0, 1}},
    {{0, 1, 0, 1, 1, 1, 0, 1}, {0, 0, 1, 0, 0, 1, 0, 0}},
    {{1, 1, 0, 1, 1, 1, 0, 1}, {1, 0, 0, 1, 1, 0, 0, 1}},
    {{0, 0, 1, 1, 1, 1, 0, 1}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 1, 1, 1, 0, 1}, {1, 0, 0, 1, 0, 0, 0, 1}},
    {{0, 1, 1, 1, 1, 1, 0, 1}, {0, 0, 1, 0, 0, 0, 0, 0}},
    {{1, 1, 1, 1, 1, 1, 0, 1}, {1, 0, 0, 0, 0, 0, 0, 1}},
    {{0, 0, 0, 0, 0, 0, 1, 1}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 0, 0, 1, 1}, {1, 0, 0, 0, 0, 0, 0, 1}},
    {{0, 1, 0, 0, 0, 0, 1, 1}, {0, 0, 1, 0, 0, 0, 0, 0}},
    {{1, 1, 0, 0, 0, 0, 1, 1}, {1, 0, 0, 1, 0, 0, 0, 1}},
    {{0, 0, 1, 0, 0, 0, 1, 1}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 0, 0, 0, 1, 1}, {1, 0, 0, 1, 1, 0, 0, 1}},
    {{0, 1, 1, 0, 0, 0, 1, 1}, {0, 0, 1, 0, 0, 1, 0, 0}},
    {{1, 1, 1, 0, 0, 0, 1, 1}, {1, 0, 0, 0, 1, 1, 0, 1}},
    {{0, 0, 0, 1, 0, 0, 1, 1}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 0, 0, 1, 1}, {1, 0, 0, 0, 1, 0, 1, 1}},
    {{0, 1, 0, 1, 0, 0, 1, 1}, {0, 0, 1, 0, 0, 1, 1, 0}},
    {{1, 1, 0, 1, 0, 0, 1, 1}, {1, 0, 0, 1, 1, 1, 1, 1}},
    {{0, 0, 1, 1, 0, 0, 1, 1}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 1, 0, 0, 1, 1}, {1, 0, 0, 1, 0, 1, 0, 0}},
    {{0, 1, 1, 1, 0, 0, 1, 1}, {0, 0, 1, 0, 0, 0, 1, 1}},
    {{1, 1, 1, 1, 0, 0, 1, 1}, {1, 0, 0, 0, 0, 1, 1, 0}},
    {{0, 0, 0, 0, 1, 0, 1, 1}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 1, 0, 1, 1}, {1, 0, 0, 0, 0, 1, 0, 1}},
    {{0, 1, 0, 0, 1, 0, 1, 1}, {0, 0, 1, 0, 0, 0, 1, 0}},
    {{1, 1, 0, 0, 1, 0, 1, 1}, {1, 0, 0, 1, 0, 1, 1, 1}},
    {{0, 0, 1, 0, 1, 0, 1, 1}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 0, 1, 0, 1, 1}, {1, 0, 0, 1, 1, 1, 0, 0}},
    {{0, 1, 1, 0, 1, 0, 1, 1}, {0, 0, 1, 0, 0, 1, 1, 1}},
    {{1, 1, 1, 0, 1, 0, 1, 1}, {1, 0, 0, 0, 1, 0, 0, 1}},
    {{0, 0, 0, 1, 1, 0, 1, 1}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 1, 0, 1, 1}, {1, 0, 0, 0, 1, 1, 1, 1}},
    {{0, 1, 0, 1, 1, 0, 1, 1}, {0, 0, 1, 0, 0, 1, 0, 1}},
    {{1, 1, 0, 1, 1, 0, 1, 1}, {1, 0, 0, 1, 1, 0, 1, 0}},
    {{0, 0, 1, 1, 1, 0, 1, 1}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 1, 1, 0, 1, 1}, {1, 0, 0, 1, 0, 0, 1, 1}},
    {{0, 1, 1, 1, 1, 0, 1, 1}, {0, 0, 1, 0, 0, 0, 0, 1}},
    {{1, 1, 1, 1, 1, 0, 1, 1}, {1, 0, 0, 0, 0, 0, 1, 0}},
    {{0, 0, 0, 0, 0, 1, 1, 1}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 0, 1, 1, 1}, {1, 0, 0, 0, 0, 0, 1, 1}},
    {{0, 1, 0, 0, 0, 1, 1, 1}, {0, 0, 1, 0, 0, 0, 0, 1}},
    {{1, 1, 0, 0, 0, 1, 1, 1}, {1, 0, 0, 1, 0, 0, 1, 0}},
    {{0, 0, 1, 0, 0, 1, 1, 1}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 0, 0, 1, 1, 1}, {1, 0, 0, 1, 1, 0, 1, 1}},
    {{0, 1, 1, 0, 0, 1, 1, 1}, {0, 0, 1, 0, 0, 1, 0, 1}},
    {{1, 1, 1, 0, 0, 1, 1, 1}, {1, 0, 0, 0, 1, 1, 1, 0}},
    {{0, 0, 0, 1, 0, 1, 1, 1}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 0, 1, 1, 1}, {1, 0, 0, 0, 1, 0, 0, 0}},
    {{0, 1, 0, 1, 0, 1, 1, 1}, {0, 0, 1, 0, 0, 1, 1, 1}},
    {{1, 1, 0, 1, 0, 1, 1, 1}, {1, 0, 0, 1, 1, 1, 0, 1}},
    {{0, 0, 1, 1, 0, 1, 1, 1}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 1, 0, 1, 1, 1}, {1, 0, 0, 1, 0, 1, 1, 0}},
    {{0, 1, 1, 1, 0, 1, 1, 1}, {0, 0, 1, 0, 0, 0, 1, 0}},
    {{1, 1, 1, 1, 0, 1, 1, 1}, {1, 0, 0, 0, 0, 1, 0, 0}},
    {{0, 0, 0, 0, 1, 1, 1, 1}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 1, 1, 1, 1}, {1, 0, 0, 0, 0, 1, 1, 1}},
    {{0, 1, 0, 0, 1, 1, 1, 1}, {0, 0, 1, 0, 0, 0, 1, 1}},
    {{1, 1, 0, 0, 1, 1, 1, 1}, {1, 0, 0, 1, 0, 1, 0, 1}},
    {{0, 0, 1, 0, 1, 1, 1, 1}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 0, 1, 1, 1, 1}, {1, 0, 0, 1, 1, 1, 1, 0}},
    {{0, 1, 1, 0, 1, 1, 1, 1}, {0, 0, 1, 0, 0, 1, 1, 0}},
    {{1, 1, 1, 0, 1, 1, 1, 1}, {1, 0, 0, 0, 1, 0, 1, 0}},
    {{0, 0, 0, 1, 1, 1, 1, 1}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 1, 1, 1, 1}, {1, 0, 0, 0, 1, 1, 0, 0}},
    {{0, 1, 0, 1, 1, 1, 1, 1}, {0, 0, 1, 0, 0, 1, 0, 0}},
    {{1, 1, 0, 1, 1, 1, 1, 1}, {1, 0, 0, 1, 1, 0, 0, 0}},
    {{0, 0, 1, 1, 1, 1, 1, 1}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 1, 1, 1, 1, 1}, {1, 0, 0, 1, 0, 0, 0, 0}},
    {{0, 1, 1, 1, 1, 1, 1, 1}, {0, 0, 1, 0, 0, 0, 0, 0}},
    {{1, 1, 1, 1, 1, 1, 1, 1}, {1, 0, 0, 0, 0, 0, 0, 0}}
};

uint32_t train_micronet_neurons[] = {
    // idx  num_inputs  type 	indices
    // Layer 1
	   8,	8,			1,		0, 1, 2, 3, 4, 5, 6, 7,
	   9,	8,			1,		0, 1, 2, 3, 4, 5, 6, 7,
	   10,	8,			1,		0, 1, 2, 3, 4, 5, 6, 7,
	   11,	8,			1,		0, 1, 2, 3, 4, 5, 6, 7,
	   12,	8,			1,		0, 1, 2, 3, 4, 5, 6, 7,
	   13,	8,			1,		0, 1, 2, 3, 4, 5, 6, 7,
	   14,	8,			1,		0, 1, 2, 3, 4, 5, 6, 7,
	   15,	8,			1,		0, 1, 2, 3, 4, 5, 6, 7,
    // Layer 2
	   16,	8,			1,		8, 9, 10, 11, 12, 13, 14, 15,
	   17,	8,			1,		8, 9, 10, 11, 12, 13, 14, 15,
	   18,	8,			1,		8, 9, 10, 11, 12, 13, 14, 15,
	   19,	8,			1,		8, 9, 10, 11, 12, 13, 14, 15,
	   20,	8,			1,		8, 9, 10, 11, 12, 13, 14, 15,
	   21,	8,			1,		8, 9, 10, 11, 12, 13, 14, 15,
	   22,	8,			1,		8, 9, 10, 11, 12, 13, 14, 15,
	   23,	8,			1,		8, 9, 10, 11, 12, 13, 14, 15,
	// Outputs:
	   24,	8,			1,		16, 17, 18, 19, 20, 21, 22, 23,
	   25,	8,			1,		16, 17, 18, 19, 20, 21, 22, 23,
	   26,	8,			1,		16, 17, 18, 19, 20, 21, 22, 23,
	   27,	8,			1,		16, 17, 18, 19, 20, 21, 22, 23,
	   28,	8,			1,		16, 17, 18, 19, 20, 21, 22, 23,
	   29,	8,			1,		16, 17, 18, 19, 20, 21, 22, 23,
	   30,	8,			1,		16, 17, 18, 19, 20, 21, 22, 23,
	   31,	8,			1,		16, 17, 18, 19, 20, 21, 22, 23,
};

network_map_t train_micronet_map = {
	.num_inputs = 8,
	.num_neurons = 24,
	.net_size = 32,
	.neurons = train_micronet_neurons,
	.num_outputs = 8,
	.output_indices = {24, 25, 26, 27, 28, 29, 30, 31, 32},
};

double update_value(double value) {
    double temp = value * 100;
    if(temp > 1) {temp = 1;}
    else if(temp < -1) {temp = -1;}
    return temp;
}

static double get_error(network_t *config, dataset_item_t *dataset, size_t dataset_size, uint32_t num_outputs, uint8_t to_print) {
    double error = 0;
    uint32_t correct_sign_count = 0;
    uint32_t correct_high_count = 0;
    uint32_t high_count = 0;
    for(size_t i=0; i<dataset_size; i++) {
        double *outputs = network_get_output(config, dataset[i].inputs);
        double delta = 0;
        uint32_t delta_counter = 0;
        for(uint32_t j=0; j<num_outputs-1; j++) {
            double local_delta = 0;
            double target_value = update_value(dataset[i].output[j]);
            if(target_value == 0) {
                local_delta = outputs[j];
            } else {
                local_delta = (outputs[j] - target_value) / target_value;
            }
            if(local_delta < 0) {
                local_delta = -1 * local_delta;
            }
            delta += local_delta;
            delta_counter ++;
        }
        delta /= delta_counter;

        // double e = delta * delta;
        if(to_print) {
            if(delta < 1) {
                correct_sign_count += 100;
            }
            if(outputs[0] > 0) {
                high_count += 1;
                if(dataset[i].output[num_outputs-1] > 0) {
                    correct_high_count += 1;
                }
            }
            // printf("Desired outputs: [");
            // printf("%f], ", target_value);

            // printf("real outputs: [");
            // for(uint32_t j=0; j<num_outputs-1; j++) {
            //     printf("%f, ", outputs[j]);
            // }
            // printf("%f]; ", outputs[num_outputs-1]);
            // printf("error = %f;\n", delta);
        }
        error += delta;
    }
    network_clear_outputs(config);  // Clear neurons outputs to not affect the next round
    if(to_print) {
        printf("\tCorrect sign counter = %f percent\n", (double) correct_sign_count / dataset_size);
        printf("\tCorrect high counter = %d of %d\n", correct_high_count, high_count);
        fflush(stdout);
    }
    return error / dataset_size;
}

int run_evolution(network_t *config) {
    double current_error = get_error(config, train_dataset, sizeof_arr(train_dataset), 8, 0);
    size_t counter = 0, print_counter = 0;
    while((current_error > 0.001) && (counter++ < 1000)) {
        network_mutate(config);
        double new_error = get_error(config, train_dataset, sizeof_arr(train_dataset), 8, 0);
        // printf("New error: %f, counter = %lld\n", new_error, counter);
        // fflush(stdout);
        // break;
        if(new_error > current_error) {
            network_rollback(config);
        } else {
            current_error = new_error;
            if(print_counter++ == 100) {
                printf("New error: %f, counter = %lld\n", new_error, counter);
                fflush(stdout);
                print_counter = 0;
            }
        }
    }
    get_error(config, train_dataset, sizeof_arr(train_dataset), 71, 1);
    
    // double after_error = get_error(config, train_dataset, sizeof_arr(train_dataset), 71, 0);
    // if(after_error != current_error) {
    //     printf("ERROR: after_error != current_error: after_error = %f, current_error = %f\n", after_error, current_error);
    //     return EXIT_FAILURE;
    // }

    return EXIT_SUCCESS;
}

int main(void) {
    char *n_path = concat_strings(BCKP_DIR_PATH, "/train_micronet");
    srand(time(NULL));
    network_t *unet = calloc(1, sizeof(network_t));
    network_init_micronet(unet, &train_micronet_map);
    printf("MicroNet initialised!\n");

    // Restore network
    // network_restore(unet, n_path, 1);
    // network_print_coeffs(unet);
    // return EXIT_SUCCESS;

    printf("Initial error: %f\n", get_error(unet, train_dataset, sizeof_arr(train_dataset), 8, 1));
    fflush(stdout);

    for(int i=0; i<1000; i++) {
        run_evolution(unet);

        // Save network
        network_save(unet, n_path);
    }
    free(n_path);

    return EXIT_SUCCESS;
}