#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <math.h>
#include "network.h"
#include "utils.h"

// Micronet config:
// #include "dataset_large_1000.h"
#include "micro_maps/config_feedback_micronet.h"
#include "micro_maps/config_poly_micronet.h"

#define sizeof_arr(_x) sizeof(_x)/sizeof(_x[0])

typedef struct {
    double inputs[8];
    double output[8];
} dataset_item_t;

dataset_item_t train_dataset[] = {
    {{0, 0, 0, 0, 0, 0, 0, 0}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 0, 0, 0, 0}, {1, 0, 0, 0, 0, 0, 0, 0}},
    {{0, 1, 0, 0, 0, 0, 0, 0}, {0, 0, 1, 0, 0, 0, 0, 0}},
    {{1, 1, 0, 0, 0, 0, 0, 0}, {1, 0, 0, 1, 0, 0, 0, 0}},
    {{0, 0, 1, 0, 0, 0, 0, 0}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 0, 0, 0, 0, 0}, {1, 0, 0, 1, 1, 0, 0, 0}},
    {{0, 1, 1, 0, 0, 0, 0, 0}, {0, 0, 1, 0, 0, 1, 0, 0}},
    {{1, 1, 1, 0, 0, 0, 0, 0}, {1, 0, 0, 0, 1, 1, 0, 0}},
    {{0, 0, 0, 1, 0, 0, 0, 0}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 0, 0, 0, 0}, {1, 0, 0, 0, 1, 0, 1, 0}},
    {{0, 1, 0, 1, 0, 0, 0, 0}, {0, 0, 1, 0, 0, 1, 1, 0}},
    {{1, 1, 0, 1, 0, 0, 0, 0}, {1, 0, 0, 1, 1, 1, 1, 0}},
    {{0, 0, 1, 1, 0, 0, 0, 0}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 1, 0, 0, 0, 0}, {1, 0, 0, 1, 0, 1, 0, 1}},
    {{0, 1, 1, 1, 0, 0, 0, 0}, {0, 0, 1, 0, 0, 0, 1, 1}},
    {{1, 1, 1, 1, 0, 0, 0, 0}, {1, 0, 0, 0, 0, 1, 1, 1}},
    {{0, 0, 0, 0, 1, 0, 0, 0}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 1, 0, 0, 0}, {1, 0, 0, 0, 0, 1, 0, 0}},
    {{0, 1, 0, 0, 1, 0, 0, 0}, {0, 0, 1, 0, 0, 0, 1, 0}},
    {{1, 1, 0, 0, 1, 0, 0, 0}, {1, 0, 0, 1, 0, 1, 1, 0}},
    {{0, 0, 1, 0, 1, 0, 0, 0}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 0, 1, 0, 0, 0}, {1, 0, 0, 1, 1, 1, 0, 1}},
    {{0, 1, 1, 0, 1, 0, 0, 0}, {0, 0, 1, 0, 0, 1, 1, 1}},
    {{1, 1, 1, 0, 1, 0, 0, 0}, {1, 0, 0, 0, 1, 0, 0, 0}},
    {{0, 0, 0, 1, 1, 0, 0, 0}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 1, 0, 0, 0}, {1, 0, 0, 0, 1, 1, 1, 0}},
    {{0, 1, 0, 1, 1, 0, 0, 0}, {0, 0, 1, 0, 0, 1, 0, 1}},
    {{1, 1, 0, 1, 1, 0, 0, 0}, {1, 0, 0, 1, 1, 0, 1, 1}},
    {{0, 0, 1, 1, 1, 0, 0, 0}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 1, 1, 0, 0, 0}, {1, 0, 0, 1, 0, 0, 1, 0}},
    {{0, 1, 1, 1, 1, 0, 0, 0}, {0, 0, 1, 0, 0, 0, 0, 1}},
    {{1, 1, 1, 1, 1, 0, 0, 0}, {1, 0, 0, 0, 0, 0, 1, 1}},
    {{0, 0, 0, 0, 0, 1, 0, 0}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 0, 1, 0, 0}, {1, 0, 0, 0, 0, 0, 1, 0}},
    {{0, 1, 0, 0, 0, 1, 0, 0}, {0, 0, 1, 0, 0, 0, 0, 1}},
    {{1, 1, 0, 0, 0, 1, 0, 0}, {1, 0, 0, 1, 0, 0, 1, 1}},
    {{0, 0, 1, 0, 0, 1, 0, 0}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 0, 0, 1, 0, 0}, {1, 0, 0, 1, 1, 0, 1, 0}},
    {{0, 1, 1, 0, 0, 1, 0, 0}, {0, 0, 1, 0, 0, 1, 0, 1}},
    {{1, 1, 1, 0, 0, 1, 0, 0}, {1, 0, 0, 0, 1, 1, 1, 1}},
    {{0, 0, 0, 1, 0, 1, 0, 0}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 0, 1, 0, 0}, {1, 0, 0, 0, 1, 0, 0, 1}},
    {{0, 1, 0, 1, 0, 1, 0, 0}, {0, 0, 1, 0, 0, 1, 1, 1}},
    {{1, 1, 0, 1, 0, 1, 0, 0}, {1, 0, 0, 1, 1, 1, 0, 0}},
    {{0, 0, 1, 1, 0, 1, 0, 0}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 1, 0, 1, 0, 0}, {1, 0, 0, 1, 0, 1, 1, 1}},
    {{0, 1, 1, 1, 0, 1, 0, 0}, {0, 0, 1, 0, 0, 0, 1, 0}},
    {{1, 1, 1, 1, 0, 1, 0, 0}, {1, 0, 0, 0, 0, 1, 0, 1}},
    {{0, 0, 0, 0, 1, 1, 0, 0}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 1, 1, 0, 0}, {1, 0, 0, 0, 0, 1, 1, 0}},
    {{0, 1, 0, 0, 1, 1, 0, 0}, {0, 0, 1, 0, 0, 0, 1, 1}},
    {{1, 1, 0, 0, 1, 1, 0, 0}, {1, 0, 0, 1, 0, 1, 0, 0}},
    {{0, 0, 1, 0, 1, 1, 0, 0}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 0, 1, 1, 0, 0}, {1, 0, 0, 1, 1, 1, 1, 1}},
    {{0, 1, 1, 0, 1, 1, 0, 0}, {0, 0, 1, 0, 0, 1, 1, 0}},
    {{1, 1, 1, 0, 1, 1, 0, 0}, {1, 0, 0, 0, 1, 0, 1, 1}},
    {{0, 0, 0, 1, 1, 1, 0, 0}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 1, 1, 0, 0}, {1, 0, 0, 0, 1, 1, 0, 1}},
    {{0, 1, 0, 1, 1, 1, 0, 0}, {0, 0, 1, 0, 0, 1, 0, 0}},
    {{1, 1, 0, 1, 1, 1, 0, 0}, {1, 0, 0, 1, 1, 0, 0, 1}},
    {{0, 0, 1, 1, 1, 1, 0, 0}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 1, 1, 1, 0, 0}, {1, 0, 0, 1, 0, 0, 0, 1}},
    {{0, 1, 1, 1, 1, 1, 0, 0}, {0, 0, 1, 0, 0, 0, 0, 0}},
    {{1, 1, 1, 1, 1, 1, 0, 0}, {1, 0, 0, 0, 0, 0, 0, 1}},
    {{0, 0, 0, 0, 0, 0, 1, 0}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 0, 0, 1, 0}, {1, 0, 0, 0, 0, 0, 0, 1}},
    {{0, 1, 0, 0, 0, 0, 1, 0}, {0, 0, 1, 0, 0, 0, 0, 0}},
    {{1, 1, 0, 0, 0, 0, 1, 0}, {1, 0, 0, 1, 0, 0, 0, 1}},
    {{0, 0, 1, 0, 0, 0, 1, 0}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 0, 0, 0, 1, 0}, {1, 0, 0, 1, 1, 0, 0, 1}},
    {{0, 1, 1, 0, 0, 0, 1, 0}, {0, 0, 1, 0, 0, 1, 0, 0}},
    {{1, 1, 1, 0, 0, 0, 1, 0}, {1, 0, 0, 0, 1, 1, 0, 1}},
    {{0, 0, 0, 1, 0, 0, 1, 0}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 0, 0, 1, 0}, {1, 0, 0, 0, 1, 0, 1, 1}},
    {{0, 1, 0, 1, 0, 0, 1, 0}, {0, 0, 1, 0, 0, 1, 1, 0}},
    {{1, 1, 0, 1, 0, 0, 1, 0}, {1, 0, 0, 1, 1, 1, 1, 1}},
    {{0, 0, 1, 1, 0, 0, 1, 0}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 1, 0, 0, 1, 0}, {1, 0, 0, 1, 0, 1, 0, 0}},
    {{0, 1, 1, 1, 0, 0, 1, 0}, {0, 0, 1, 0, 0, 0, 1, 1}},
    {{1, 1, 1, 1, 0, 0, 1, 0}, {1, 0, 0, 0, 0, 1, 1, 0}},
    {{0, 0, 0, 0, 1, 0, 1, 0}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 1, 0, 1, 0}, {1, 0, 0, 0, 0, 1, 0, 1}},
    {{0, 1, 0, 0, 1, 0, 1, 0}, {0, 0, 1, 0, 0, 0, 1, 0}},
    {{1, 1, 0, 0, 1, 0, 1, 0}, {1, 0, 0, 1, 0, 1, 1, 1}},
    {{0, 0, 1, 0, 1, 0, 1, 0}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 0, 1, 0, 1, 0}, {1, 0, 0, 1, 1, 1, 0, 0}},
    {{0, 1, 1, 0, 1, 0, 1, 0}, {0, 0, 1, 0, 0, 1, 1, 1}},
    {{1, 1, 1, 0, 1, 0, 1, 0}, {1, 0, 0, 0, 1, 0, 0, 1}},
    {{0, 0, 0, 1, 1, 0, 1, 0}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 1, 0, 1, 0}, {1, 0, 0, 0, 1, 1, 1, 1}},
    {{0, 1, 0, 1, 1, 0, 1, 0}, {0, 0, 1, 0, 0, 1, 0, 1}},
    {{1, 1, 0, 1, 1, 0, 1, 0}, {1, 0, 0, 1, 1, 0, 1, 0}},
    {{0, 0, 1, 1, 1, 0, 1, 0}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 1, 1, 0, 1, 0}, {1, 0, 0, 1, 0, 0, 1, 1}},
    {{0, 1, 1, 1, 1, 0, 1, 0}, {0, 0, 1, 0, 0, 0, 0, 1}},
    {{1, 1, 1, 1, 1, 0, 1, 0}, {1, 0, 0, 0, 0, 0, 1, 0}},
    {{0, 0, 0, 0, 0, 1, 1, 0}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 0, 1, 1, 0}, {1, 0, 0, 0, 0, 0, 1, 1}},
    {{0, 1, 0, 0, 0, 1, 1, 0}, {0, 0, 1, 0, 0, 0, 0, 1}},
    {{1, 1, 0, 0, 0, 1, 1, 0}, {1, 0, 0, 1, 0, 0, 1, 0}},
    {{0, 0, 1, 0, 0, 1, 1, 0}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 0, 0, 1, 1, 0}, {1, 0, 0, 1, 1, 0, 1, 1}},
    {{0, 1, 1, 0, 0, 1, 1, 0}, {0, 0, 1, 0, 0, 1, 0, 1}},
    {{1, 1, 1, 0, 0, 1, 1, 0}, {1, 0, 0, 0, 1, 1, 1, 0}},
    {{0, 0, 0, 1, 0, 1, 1, 0}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 0, 1, 1, 0}, {1, 0, 0, 0, 1, 0, 0, 0}},
    {{0, 1, 0, 1, 0, 1, 1, 0}, {0, 0, 1, 0, 0, 1, 1, 1}},
    {{1, 1, 0, 1, 0, 1, 1, 0}, {1, 0, 0, 1, 1, 1, 0, 1}},
    {{0, 0, 1, 1, 0, 1, 1, 0}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 1, 0, 1, 1, 0}, {1, 0, 0, 1, 0, 1, 1, 0}},
    {{0, 1, 1, 1, 0, 1, 1, 0}, {0, 0, 1, 0, 0, 0, 1, 0}},
    {{1, 1, 1, 1, 0, 1, 1, 0}, {1, 0, 0, 0, 0, 1, 0, 0}},
    {{0, 0, 0, 0, 1, 1, 1, 0}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 1, 1, 1, 0}, {1, 0, 0, 0, 0, 1, 1, 1}},
    {{0, 1, 0, 0, 1, 1, 1, 0}, {0, 0, 1, 0, 0, 0, 1, 1}},
    {{1, 1, 0, 0, 1, 1, 1, 0}, {1, 0, 0, 1, 0, 1, 0, 1}},
    {{0, 0, 1, 0, 1, 1, 1, 0}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 0, 1, 1, 1, 0}, {1, 0, 0, 1, 1, 1, 1, 0}},
    {{0, 1, 1, 0, 1, 1, 1, 0}, {0, 0, 1, 0, 0, 1, 1, 0}},
    {{1, 1, 1, 0, 1, 1, 1, 0}, {1, 0, 0, 0, 1, 0, 1, 0}},
    {{0, 0, 0, 1, 1, 1, 1, 0}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 1, 1, 1, 0}, {1, 0, 0, 0, 1, 1, 0, 0}},
    {{0, 1, 0, 1, 1, 1, 1, 0}, {0, 0, 1, 0, 0, 1, 0, 0}},
    {{1, 1, 0, 1, 1, 1, 1, 0}, {1, 0, 0, 1, 1, 0, 0, 0}},
    {{0, 0, 1, 1, 1, 1, 1, 0}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 1, 1, 1, 1, 0}, {1, 0, 0, 1, 0, 0, 0, 0}},
    {{0, 1, 1, 1, 1, 1, 1, 0}, {0, 0, 1, 0, 0, 0, 0, 0}},
    {{1, 1, 1, 1, 1, 1, 1, 0}, {1, 0, 0, 0, 0, 0, 0, 0}},
    {{0, 0, 0, 0, 0, 0, 0, 1}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 0, 0, 0, 1}, {1, 0, 0, 0, 0, 0, 0, 0}},
    {{0, 1, 0, 0, 0, 0, 0, 1}, {0, 0, 1, 0, 0, 0, 0, 0}},
    {{1, 1, 0, 0, 0, 0, 0, 1}, {1, 0, 0, 1, 0, 0, 0, 0}},
    {{0, 0, 1, 0, 0, 0, 0, 1}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 0, 0, 0, 0, 1}, {1, 0, 0, 1, 1, 0, 0, 0}},
    {{0, 1, 1, 0, 0, 0, 0, 1}, {0, 0, 1, 0, 0, 1, 0, 0}},
    {{1, 1, 1, 0, 0, 0, 0, 1}, {1, 0, 0, 0, 1, 1, 0, 0}},
    {{0, 0, 0, 1, 0, 0, 0, 1}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 0, 0, 0, 1}, {1, 0, 0, 0, 1, 0, 1, 0}},
    {{0, 1, 0, 1, 0, 0, 0, 1}, {0, 0, 1, 0, 0, 1, 1, 0}},
    {{1, 1, 0, 1, 0, 0, 0, 1}, {1, 0, 0, 1, 1, 1, 1, 0}},
    {{0, 0, 1, 1, 0, 0, 0, 1}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 1, 0, 0, 0, 1}, {1, 0, 0, 1, 0, 1, 0, 1}},
    {{0, 1, 1, 1, 0, 0, 0, 1}, {0, 0, 1, 0, 0, 0, 1, 1}},
    {{1, 1, 1, 1, 0, 0, 0, 1}, {1, 0, 0, 0, 0, 1, 1, 1}},
    {{0, 0, 0, 0, 1, 0, 0, 1}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 1, 0, 0, 1}, {1, 0, 0, 0, 0, 1, 0, 0}},
    {{0, 1, 0, 0, 1, 0, 0, 1}, {0, 0, 1, 0, 0, 0, 1, 0}},
    {{1, 1, 0, 0, 1, 0, 0, 1}, {1, 0, 0, 1, 0, 1, 1, 0}},
    {{0, 0, 1, 0, 1, 0, 0, 1}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 0, 1, 0, 0, 1}, {1, 0, 0, 1, 1, 1, 0, 1}},
    {{0, 1, 1, 0, 1, 0, 0, 1}, {0, 0, 1, 0, 0, 1, 1, 1}},
    {{1, 1, 1, 0, 1, 0, 0, 1}, {1, 0, 0, 0, 1, 0, 0, 0}},
    {{0, 0, 0, 1, 1, 0, 0, 1}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 1, 0, 0, 1}, {1, 0, 0, 0, 1, 1, 1, 0}},
    {{0, 1, 0, 1, 1, 0, 0, 1}, {0, 0, 1, 0, 0, 1, 0, 1}},
    {{1, 1, 0, 1, 1, 0, 0, 1}, {1, 0, 0, 1, 1, 0, 1, 1}},
    {{0, 0, 1, 1, 1, 0, 0, 1}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 1, 1, 0, 0, 1}, {1, 0, 0, 1, 0, 0, 1, 0}},
    {{0, 1, 1, 1, 1, 0, 0, 1}, {0, 0, 1, 0, 0, 0, 0, 1}},
    {{1, 1, 1, 1, 1, 0, 0, 1}, {1, 0, 0, 0, 0, 0, 1, 1}},
    {{0, 0, 0, 0, 0, 1, 0, 1}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 0, 1, 0, 1}, {1, 0, 0, 0, 0, 0, 1, 0}},
    {{0, 1, 0, 0, 0, 1, 0, 1}, {0, 0, 1, 0, 0, 0, 0, 1}},
    {{1, 1, 0, 0, 0, 1, 0, 1}, {1, 0, 0, 1, 0, 0, 1, 1}},
    {{0, 0, 1, 0, 0, 1, 0, 1}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 0, 0, 1, 0, 1}, {1, 0, 0, 1, 1, 0, 1, 0}},
    {{0, 1, 1, 0, 0, 1, 0, 1}, {0, 0, 1, 0, 0, 1, 0, 1}},
    {{1, 1, 1, 0, 0, 1, 0, 1}, {1, 0, 0, 0, 1, 1, 1, 1}},
    {{0, 0, 0, 1, 0, 1, 0, 1}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 0, 1, 0, 1}, {1, 0, 0, 0, 1, 0, 0, 1}},
    {{0, 1, 0, 1, 0, 1, 0, 1}, {0, 0, 1, 0, 0, 1, 1, 1}},
    {{1, 1, 0, 1, 0, 1, 0, 1}, {1, 0, 0, 1, 1, 1, 0, 0}},
    {{0, 0, 1, 1, 0, 1, 0, 1}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 1, 0, 1, 0, 1}, {1, 0, 0, 1, 0, 1, 1, 1}},
    {{0, 1, 1, 1, 0, 1, 0, 1}, {0, 0, 1, 0, 0, 0, 1, 0}},
    {{1, 1, 1, 1, 0, 1, 0, 1}, {1, 0, 0, 0, 0, 1, 0, 1}},
    {{0, 0, 0, 0, 1, 1, 0, 1}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 1, 1, 0, 1}, {1, 0, 0, 0, 0, 1, 1, 0}},
    {{0, 1, 0, 0, 1, 1, 0, 1}, {0, 0, 1, 0, 0, 0, 1, 1}},
    {{1, 1, 0, 0, 1, 1, 0, 1}, {1, 0, 0, 1, 0, 1, 0, 0}},
    {{0, 0, 1, 0, 1, 1, 0, 1}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 0, 1, 1, 0, 1}, {1, 0, 0, 1, 1, 1, 1, 1}},
    {{0, 1, 1, 0, 1, 1, 0, 1}, {0, 0, 1, 0, 0, 1, 1, 0}},
    {{1, 1, 1, 0, 1, 1, 0, 1}, {1, 0, 0, 0, 1, 0, 1, 1}},
    {{0, 0, 0, 1, 1, 1, 0, 1}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 1, 1, 0, 1}, {1, 0, 0, 0, 1, 1, 0, 1}},
    {{0, 1, 0, 1, 1, 1, 0, 1}, {0, 0, 1, 0, 0, 1, 0, 0}},
    {{1, 1, 0, 1, 1, 1, 0, 1}, {1, 0, 0, 1, 1, 0, 0, 1}},
    {{0, 0, 1, 1, 1, 1, 0, 1}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 1, 1, 1, 0, 1}, {1, 0, 0, 1, 0, 0, 0, 1}},
    {{0, 1, 1, 1, 1, 1, 0, 1}, {0, 0, 1, 0, 0, 0, 0, 0}},
    {{1, 1, 1, 1, 1, 1, 0, 1}, {1, 0, 0, 0, 0, 0, 0, 1}},
    {{0, 0, 0, 0, 0, 0, 1, 1}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 0, 0, 1, 1}, {1, 0, 0, 0, 0, 0, 0, 1}},
    {{0, 1, 0, 0, 0, 0, 1, 1}, {0, 0, 1, 0, 0, 0, 0, 0}},
    {{1, 1, 0, 0, 0, 0, 1, 1}, {1, 0, 0, 1, 0, 0, 0, 1}},
    {{0, 0, 1, 0, 0, 0, 1, 1}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 0, 0, 0, 1, 1}, {1, 0, 0, 1, 1, 0, 0, 1}},
    {{0, 1, 1, 0, 0, 0, 1, 1}, {0, 0, 1, 0, 0, 1, 0, 0}},
    {{1, 1, 1, 0, 0, 0, 1, 1}, {1, 0, 0, 0, 1, 1, 0, 1}},
    {{0, 0, 0, 1, 0, 0, 1, 1}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 0, 0, 1, 1}, {1, 0, 0, 0, 1, 0, 1, 1}},
    {{0, 1, 0, 1, 0, 0, 1, 1}, {0, 0, 1, 0, 0, 1, 1, 0}},
    {{1, 1, 0, 1, 0, 0, 1, 1}, {1, 0, 0, 1, 1, 1, 1, 1}},
    {{0, 0, 1, 1, 0, 0, 1, 1}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 1, 0, 0, 1, 1}, {1, 0, 0, 1, 0, 1, 0, 0}},
    {{0, 1, 1, 1, 0, 0, 1, 1}, {0, 0, 1, 0, 0, 0, 1, 1}},
    {{1, 1, 1, 1, 0, 0, 1, 1}, {1, 0, 0, 0, 0, 1, 1, 0}},
    {{0, 0, 0, 0, 1, 0, 1, 1}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 1, 0, 1, 1}, {1, 0, 0, 0, 0, 1, 0, 1}},
    {{0, 1, 0, 0, 1, 0, 1, 1}, {0, 0, 1, 0, 0, 0, 1, 0}},
    {{1, 1, 0, 0, 1, 0, 1, 1}, {1, 0, 0, 1, 0, 1, 1, 1}},
    {{0, 0, 1, 0, 1, 0, 1, 1}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 0, 1, 0, 1, 1}, {1, 0, 0, 1, 1, 1, 0, 0}},
    {{0, 1, 1, 0, 1, 0, 1, 1}, {0, 0, 1, 0, 0, 1, 1, 1}},
    {{1, 1, 1, 0, 1, 0, 1, 1}, {1, 0, 0, 0, 1, 0, 0, 1}},
    {{0, 0, 0, 1, 1, 0, 1, 1}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 1, 0, 1, 1}, {1, 0, 0, 0, 1, 1, 1, 1}},
    {{0, 1, 0, 1, 1, 0, 1, 1}, {0, 0, 1, 0, 0, 1, 0, 1}},
    {{1, 1, 0, 1, 1, 0, 1, 1}, {1, 0, 0, 1, 1, 0, 1, 0}},
    {{0, 0, 1, 1, 1, 0, 1, 1}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 1, 1, 0, 1, 1}, {1, 0, 0, 1, 0, 0, 1, 1}},
    {{0, 1, 1, 1, 1, 0, 1, 1}, {0, 0, 1, 0, 0, 0, 0, 1}},
    {{1, 1, 1, 1, 1, 0, 1, 1}, {1, 0, 0, 0, 0, 0, 1, 0}},
    {{0, 0, 0, 0, 0, 1, 1, 1}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 0, 1, 1, 1}, {1, 0, 0, 0, 0, 0, 1, 1}},
    {{0, 1, 0, 0, 0, 1, 1, 1}, {0, 0, 1, 0, 0, 0, 0, 1}},
    {{1, 1, 0, 0, 0, 1, 1, 1}, {1, 0, 0, 1, 0, 0, 1, 0}},
    {{0, 0, 1, 0, 0, 1, 1, 1}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 0, 0, 1, 1, 1}, {1, 0, 0, 1, 1, 0, 1, 1}},
    {{0, 1, 1, 0, 0, 1, 1, 1}, {0, 0, 1, 0, 0, 1, 0, 1}},
    {{1, 1, 1, 0, 0, 1, 1, 1}, {1, 0, 0, 0, 1, 1, 1, 0}},
    {{0, 0, 0, 1, 0, 1, 1, 1}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 0, 1, 1, 1}, {1, 0, 0, 0, 1, 0, 0, 0}},
    {{0, 1, 0, 1, 0, 1, 1, 1}, {0, 0, 1, 0, 0, 1, 1, 1}},
    {{1, 1, 0, 1, 0, 1, 1, 1}, {1, 0, 0, 1, 1, 1, 0, 1}},
    {{0, 0, 1, 1, 0, 1, 1, 1}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 1, 0, 1, 1, 1}, {1, 0, 0, 1, 0, 1, 1, 0}},
    {{0, 1, 1, 1, 0, 1, 1, 1}, {0, 0, 1, 0, 0, 0, 1, 0}},
    {{1, 1, 1, 1, 0, 1, 1, 1}, {1, 0, 0, 0, 0, 1, 0, 0}},
    {{0, 0, 0, 0, 1, 1, 1, 1}, {0, 0, 0, 0, 0, 0, 0, 0}},
    {{1, 0, 0, 0, 1, 1, 1, 1}, {1, 0, 0, 0, 0, 1, 1, 1}},
    {{0, 1, 0, 0, 1, 1, 1, 1}, {0, 0, 1, 0, 0, 0, 1, 1}},
    {{1, 1, 0, 0, 1, 1, 1, 1}, {1, 0, 0, 1, 0, 1, 0, 1}},
    {{0, 0, 1, 0, 1, 1, 1, 1}, {0, 0, 0, 0, 1, 0, 0, 1}},
    {{1, 0, 1, 0, 1, 1, 1, 1}, {1, 0, 0, 1, 1, 1, 1, 0}},
    {{0, 1, 1, 0, 1, 1, 1, 1}, {0, 0, 1, 0, 0, 1, 1, 0}},
    {{1, 1, 1, 0, 1, 1, 1, 1}, {1, 0, 0, 0, 1, 0, 1, 0}},
    {{0, 0, 0, 1, 1, 1, 1, 1}, {0, 0, 0, 0, 0, 0, 1, 0}},
    {{1, 0, 0, 1, 1, 1, 1, 1}, {1, 0, 0, 0, 1, 1, 0, 0}},
    {{0, 1, 0, 1, 1, 1, 1, 1}, {0, 0, 1, 0, 0, 1, 0, 0}},
    {{1, 1, 0, 1, 1, 1, 1, 1}, {1, 0, 0, 1, 1, 0, 0, 0}},
    {{0, 0, 1, 1, 1, 1, 1, 1}, {0, 0, 0, 0, 1, 0, 0, 0}},
    {{1, 0, 1, 1, 1, 1, 1, 1}, {1, 0, 0, 1, 0, 0, 0, 0}},
    {{0, 1, 1, 1, 1, 1, 1, 1}, {0, 0, 1, 0, 0, 0, 0, 0}},
    {{1, 1, 1, 1, 1, 1, 1, 1}, {1, 0, 0, 0, 0, 0, 0, 0}}
};

#define DATASET train_dataset
#define DATASET_SIZE sizeof_arr(DATASET)
#define NUM_OUTPUTS sizeof_arr(DATASET[0].output)

uint32_t train_micronet_neurons[] = {
    // idx  num_inputs  type 	indices
    // Layer 1
	   8,	8,			1,		0, 1, 2, 3, 4, 5, 6, 7,
	   9,	8,			1,		0, 1, 2, 3, 4, 5, 6, 7,
	   10,	8,			1,		0, 1, 2, 3, 4, 5, 6, 7,
	   11,	8,			1,		0, 1, 2, 3, 4, 5, 6, 7,
	   12,	8,			1,		0, 1, 2, 3, 4, 5, 6, 7,
	   13,	8,			1,		0, 1, 2, 3, 4, 5, 6, 7,
	   14,	8,			1,		0, 1, 2, 3, 4, 5, 6, 7,
	   15,	8,			1,		0, 1, 2, 3, 4, 5, 6, 7,
    // Layer 2
	   16,	8,			1,		8, 9, 10, 11, 12, 13, 14, 15,
	   17,	8,			1,		8, 9, 10, 11, 12, 13, 14, 15,
	   18,	8,			1,		8, 9, 10, 11, 12, 13, 14, 15,
	   19,	8,			1,		8, 9, 10, 11, 12, 13, 14, 15,
	   20,	8,			1,		8, 9, 10, 11, 12, 13, 14, 15,
	   21,	8,			1,		8, 9, 10, 11, 12, 13, 14, 15,
	   22,	8,			1,		8, 9, 10, 11, 12, 13, 14, 15,
	   23,	8,			1,		8, 9, 10, 11, 12, 13, 14, 15,
	// Outputs:
	   24,	8,			1,		16, 17, 18, 19, 20, 21, 22, 23,
	   25,	8,			1,		16, 17, 18, 19, 20, 21, 22, 23,
	   26,	8,			1,		16, 17, 18, 19, 20, 21, 22, 23,
	   27,	8,			1,		16, 17, 18, 19, 20, 21, 22, 23,
	   28,	8,			1,		16, 17, 18, 19, 20, 21, 22, 23,
	   29,	8,			1,		16, 17, 18, 19, 20, 21, 22, 23,
	   30,	8,			1,		16, 17, 18, 19, 20, 21, 22, 23,
	   31,	8,			1,		16, 17, 18, 19, 20, 21, 22, 23,
};

network_map_t train_micronet_map = {
	.num_inputs = 8,
	.num_neurons = 24,
	.net_size = 32,
	.neurons = train_micronet_neurons,
	.num_outputs = 8,
	.output_indices = {24, 25, 26, 27, 28, 29, 30, 31, 32},
};

static double get_error(network_t *config, dataset_item_t *dataset, size_t dataset_size, uint32_t num_outputs, uint8_t to_print) {
    double error = 0;
    for(uint32_t i=0; i<dataset_size; i++) {
        double round_error = 0;

        double *outputs = network_get_output(config, dataset[i].inputs);
        for(uint32_t j=0; j<num_outputs; j++) {
            double local_error = 0;
            double target_value = dataset[i].output[j];
            if(target_value == 0) {
                local_error = outputs[j];
            } else {
                local_error = (outputs[j] - target_value) / target_value;
            }
            if(local_error < 0) {
                local_error = -1 * local_error;
            }
            round_error += local_error;
            if(local_error > 2) {
                printf("Error: local error is too large: %f\n", local_error);
                printf("outputs[%d] = %f\n", j, outputs[j]);
                printf("dataset[%d].output[%d] = %f\n", i, j, dataset[i].output[j]);
                exit(EXIT_FAILURE);
            }
        }
        round_error /= num_outputs;
        error += round_error;
        if(round_error > 2) {
            to_print = 1;
            printf("Error: round error is too large!\n");
        }

        if(to_print) {
            printf("Iteration %d:\n", i);
            printf("Desired outputs: [");
            for(uint32_t j=0; j<num_outputs; j++) {
                printf("%.2f ", dataset[i].output[j]);
            }
            printf("]\n");
            printf("   Real outputs: [");
            for(uint32_t j=0; j<num_outputs; j++) {
                printf("%.2f ", outputs[j]);
            }
            printf("]\n");
            printf("error = %f;\n", round_error);
            fflush(stdout);
        }
        if(round_error > 2) exit(EXIT_FAILURE);
    }
    network_clear_outputs(config);  // Clear neurons outputs to not affect the next round
    return error / dataset_size;
}

int run_evolution(network_t *config) {
    double current_error = get_error(config, DATASET, DATASET_SIZE, NUM_OUTPUTS, 0);
    size_t counter = 0, print_counter = 0;
    while((current_error > 0.001) && (counter++ < 1000)) {
        network_mutate(config);
        double new_error = get_error(config, DATASET, DATASET_SIZE, NUM_OUTPUTS, 0);
        // printf("New error: %f, counter = %lld\n", new_error, counter);
        // fflush(stdout);
        // break;
        if(new_error > current_error) {
            network_rollback(config);
        } else {
            current_error = new_error;
            if(print_counter++ == 100) {
                printf("New error: %f, counter = %lld\n", new_error, counter);
                fflush(stdout);
                print_counter = 0;
            }
        }
    }
    current_error = get_error(config, DATASET, DATASET_SIZE, NUM_OUTPUTS, 1);
    printf("Final error: %f\n", current_error);
    
    // double after_error = get_error(config, DATASET, DATASET_SIZE, NUM_OUTPUTS, 0);
    // if(after_error != current_error) {
    //     printf("ERROR: after_error != current_error: after_error = %f, current_error = %f\n", after_error, current_error);
    //     return EXIT_FAILURE;
    // }

    return EXIT_SUCCESS;
}

int main(void) {
    char *n_path = concat_strings(BCKP_DIR_PATH, "/train_micronet");
    srand(time(NULL));
    network_t *unet = calloc(1, sizeof(network_t));
    network_init_micronet(unet, &train_micronet_map);
    printf("MicroNet initialised!\n");

    // Restore network
    network_restore(unet, n_path, 1);
    // network_print_coeffs(unet);
    // return EXIT_SUCCESS;

    printf("Initial error: %f\n", get_error(unet, DATASET, DATASET_SIZE, NUM_OUTPUTS, 0));
    fflush(stdout);

    for(int i=0; i<1000; i++) {
        run_evolution(unet);

        // Save network
        network_save(unet, n_path);
    }
    free(n_path);

    return EXIT_SUCCESS;
}